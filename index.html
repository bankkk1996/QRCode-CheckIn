<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #reader {
            margin: 0 auto;
            max-width: 400px;
            width: 100%;
            height: auto;
        }
        #loading {
            display: none;
            font-size: 18px;
            color: blue;
            margin-top: 10px;
        }
        #error-message {
            color: red;
            margin-top: 10px;
        }
        #restart-btn {
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #restart-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Scan QR Code</h1>

    <!-- กรอบสำหรับแสดงการสแกน QR Code -->
    <div id="reader"></div>

    <!-- ข้อความแจ้งเตือน -->
    <div id="loading">Processing...</div>
    <div id="error-message"></div>

    <button id="restart-btn" onclick="restartScanner()">Start Again</button>

    <script>
        let html5QrCode;
        let cameraId;

        // ฟังก์ชันที่ใช้สำหรับการประมวลผลหลังจากสแกน QR Code
        async function onScanSuccess(decodedText) {
            console.log(`QR Code Scanned: ${decodedText}`);
            alert(`QR Code Scanned: ${decodedText}`);

            // หยุดการสแกนหลังจากสแกนสำเร็จ
            if (html5QrCode) {
                await html5QrCode.stop();
            }

            // แสดงปุ่มเริ่มใหม่
            document.getElementById('restart-btn').style.display = 'inline-block';
        }

        // ฟังก์ชันจัดการข้อผิดพลาด
        function onScanError(errorMessage) {
            console.warn("Scan error:", errorMessage);
        }

        // ฟังก์ชันสำหรับเริ่มต้นกล้อง
        async function startCamera() {
            try {
                // รับรายการกล้องทั้งหมด
                const cameras = await Html5Qrcode.getCameras();

                // เลือกกล้องหลังโดยการค้นหาคำว่า "back" ใน label
                const backCamera = cameras.find(camera => camera.label.toLowerCase().includes('environment'));

                if (!backCamera) {
                    alert("No back camera found.");
                    return;
                }

                cameraId = backCamera.id;

                // เริ่มต้น Html5QrCode สำหรับการสแกน
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    cameraId,
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanError
                );

            } catch (error) {
                console.error("Error initializing camera:", error);
                document.getElementById('error-message').textContent = "Error initializing camera.";
            }
        }

        // ฟังก์ชันสำหรับเริ่มต้นใหม่
        function restartScanner() {
            document.getElementById('restart-btn').style.display = 'none';
            startCamera();
        }

        // เริ่มต้นการทำงาน
        startCamera();
    </script>
</body>
</html>
