<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #reader {
            margin: 0 auto;
            max-width: 400px;
            width: 100%;
            height: auto;
        }
        #loading {
            display: none;
            font-size: 18px;
            color: blue;
            margin-top: 10px;
        }
        #error-message {
            color: red;
            margin-top: 10px;
        }
        #restart-btn {
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #restart-btn:hover {
            background-color: #45a049;
        }
        #camera-select {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Scan QR Code</h1>

    <!-- กรอบสำหรับแสดงการสแกน QR Code -->
    <div id="reader"></div>

    <!-- เลือกกล้อง -->
    <select id="camera-select"></select>

    <!-- ข้อความแจ้งเตือน -->
    <div id="loading">Processing...</div>
    <div id="error-message"></div>

    <!-- ปุ่มเริ่มใหม่ -->
    <button id="restart-btn" onclick="restartScanner()">Start Again</button>

    <script>
        let html5QrCode;
        let currentCameraId;

        // ฟังก์ชันที่ใช้สำหรับการประมวลผลหลังจากสแกน QR Code
        async function onScanSuccess(decodedText) {
            console.log(`QR Code Scanned: ${decodedText}`);
            alert(`QR Code Scanned: ${decodedText}`);

            // หยุดการสแกนหลังจากสแกนสำเร็จ
            if (html5QrCode) {
                await html5QrCode.stop();
            }

            // แสดงปุ่มเริ่มใหม่
            document.getElementById('restart-btn').style.display = 'inline-block';
        }

        // ฟังก์ชันจัดการข้อผิดพลาด
        function onScanError(errorMessage) {
            console.warn("Scan error:", errorMessage);
        }

        // ฟังก์ชันสำหรับเริ่มต้นกล้อง
        async function startCamera(cameraId = null) {
            try {
                html5QrCode = new Html5QrCode("reader");

                // ใช้กล้องที่เลือก
                await html5QrCode.start(
                    cameraId,
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanError
                );

            } catch (error) {
                console.error("Error initializing camera:", error);
                document.getElementById('error-message').textContent = "Error initializing camera.";
            }
        }

        // ฟังก์ชันสำหรับโหลดรายการกล้อง
        async function loadCameras() {
            try {
                const cameras = await Html5Qrcode.getCameras();
                const cameraSelect = document.getElementById('camera-select');

                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.text = camera.label || `Camera ${camera.id}`;
                    cameraSelect.appendChild(option);
                });

                // ตั้งค่ากล้องแรกเป็นค่าปกติ
                if (cameras.length > 0) {
                    currentCameraId = cameras[0].id;
                    cameraSelect.value = currentCameraId;
                    startCamera(currentCameraId);
                }

                cameraSelect.addEventListener('change', async () => {
                    if (html5QrCode) {
                        await html5QrCode.stop();
                    }
                    currentCameraId = cameraSelect.value;
                    startCamera(currentCameraId);
                });

            } catch (error) {
                console.error("Error loading cameras:", error);
                document.getElementById('error-message').textContent = "Error loading cameras.";
            }
        }

        // ฟังก์ชันสำหรับเริ่มต้นใหม่
        function restartScanner() {
            document.getElementById('restart-btn').style.display = 'none';
            startCamera(currentCameraId);
        }

        // โหลดกล้องและเริ่มต้นการทำงาน
        loadCameras();
    </script>
</body>
</html>
