<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>
    <script type="module">
      import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";
      let sheetData = [];

      // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
      async function fetchGoogleSheetData() {
        const spreadsheetId = "1B_WgsRqY5dZ0LLOly-6CZP9qpmKw7Q9AQuOg9hVi-5M";
        const sheetName = "‡∏ä‡∏µ‡∏ï1";
        const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

        try {
          const response = await fetch(url);
          let text = await response.text();

          // ‚úÖ ‡∏•‡∏ö Prefix ‡∏ó‡∏µ‡πà Google ‡πÉ‡∏™‡πà‡∏°‡∏≤
          text = text
            .replace("/*O_o*/", "")
            .replace("google.visualization.Query.setResponse(", "")
            .slice(0, -2);

          const jsonData = JSON.parse(text);
          const rows = jsonData.table.rows.map((row) =>
            row.c.map((cell) => (cell ? cell.v : ""))
          );

          console.log("‚úÖ Google Sheets Data Loaded:", rows);
          return rows;
        } catch (error) {
          console.error("‚ùå Error fetching Google Sheets data:", error);
          return [];
        }
      }

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR Code ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Google Sheets ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      async function checkQRCode(decodedText) {
        if (!sheetData || sheetData.length === 0) {
          console.warn("‚ö† No data loaded from Google Sheets.");
          return -1;
        }

        const fieldIndex = 12; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö QR Code
        for (let i = 0; i < sheetData.length; i++) {
          let cellValue = sheetData[i][fieldIndex]
            ? sheetData[i][fieldIndex].toString().trim()
            : "";

          console.log(`üîç Checking row ${i}: ${cellValue} vs ${decodedText}`);

          if (cellValue === decodedText) {
            return i; // ‚úÖ ‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
          }
        }

        return -1; // ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      }

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets
      function updateSheet(rowIndex) {
        var row = rowIndex + 1;
        var column = 23;
        var value = "Check-in";

        var url =
          "https://script.google.com/macros/s/AKfycbzg97y7vRPBvu3x5jsUjV1EgMkxGOEJa9Aqk3DNUWlifVfc60cJyJ7UIyf5ct7e-2lwPA/exec";

        console.log(`üìå Updating row: ${row}, column: ${column}, value: ${value}`);

        fetch(url, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ row: row, column: column, value: value }),
        })
          .then(() => {
            alert("‚úÖ Updated successfully!");
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
          });
      }

      // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      window.onload = async () => {
        const video = document.getElementById("scanner");
        const resultElement = document.getElementById("result");
        const adminButton = document.getElementById("admin-button");

        const scanner = new QrScanner(video, async (result) => {
          const rowIndex = await checkQRCode(result);
          if (rowIndex !== -1) {
            resultElement.textContent = `‚úÖ Match found: ${result}`;
            adminButton.style.display = "block";
            adminButton.onclick = () => updateSheet(rowIndex);
          } else {
            resultElement.textContent = `‚ùå No match found for: ${result}`;
            adminButton.style.display = "none";
          }
        });

        sheetData = await fetchGoogleSheetData();
        scanner.start();
      };
    </script>
  </head>

  <body>
    <h1>QR Code Scanner</h1>
    <video id="scanner" style="width: 100%; max-width: 500px"></video>
    <p id="result">Waiting for scan...</p>
    <button id="admin-button" style="display: none; margin-top: 20px">
      Check-in for Admin
    </button>
  </body>
</html>
